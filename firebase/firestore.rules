rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function me() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function myRole() {
      return isSignedIn() ? me().data.role : null;
    }

    function myBrands() {
      return (isSignedIn() && me().data.brands is list) ? me().data.brands : [];
    }

    function brandIsAccessible(brand) {
      return brand == null || brand in myBrands();
    }

    function isAdmin() {
      return myRole() in ['owner', 'admin', 'developer'];
    }

    function isAdminForBrand(brand) {
      return isAdmin() && brandIsAccessible(brand);
    }

    function isWarehouseManagerForBrand(brand) {
      return myRole() == 'warehouse_manager' && brand != null && brandIsAccessible(brand);
    }

    function isOrderOwner(order) {
      return isSignedIn() && order.userId == request.auth.uid;
    }

    function brandOrNull(order) {
      return order.brand == null ? null : order.brand;
    }

    function orderCreator(order) {
      return order.createdBy == null ? order.userId : order.createdBy;
    }

    function canReadOrder(order) {
      let brand = brandOrNull(order);
      return isOrderOwner(order)
        || isAdminForBrand(brand)
        || isWarehouseManagerForBrand(brand);
    }

    function canCreateOrder(data) {
      let brand = brandOrNull(data);
      let creator = orderCreator(data);
      let ownerGuard = isSignedIn() && creator == request.auth.uid && brandIsAccessible(brand);
      return ownerGuard || isAdminForBrand(brand);
    }

    function canUpdateOrder(newData, existing) {
      let newBrand = brandOrNull(newData);
      let currentBrand = brandOrNull(existing);
      let creatorPreserved = orderCreator(newData) == orderCreator(existing);
      let ownerGuard =
        isOrderOwner(existing) &&
        newData.userId == existing.userId &&
        creatorPreserved &&
        brandIsAccessible(newBrand) &&
        brandIsAccessible(currentBrand);
      let adminGuard = isAdminForBrand(newBrand) && isAdminForBrand(currentBrand);
      let warehouseKivosGuard =
        newBrand == 'kivos' &&
        currentBrand == 'kivos' &&
        isWarehouseManagerForBrand('kivos');
      return ownerGuard || adminGuard || warehouseKivosGuard;
    }

    function canDeleteOrder(order) {
      return isOrderOwner(order) || isAdminForBrand(brandOrNull(order));
    }

    // --- USERS ---
    match /users/{uid} {
      allow read: if isSignedIn() && (request.auth.uid == uid || isAdmin());
      allow create: if isSignedIn() && request.auth.uid == uid;
      allow update: if isSignedIn() && (request.auth.uid == uid || isAdmin());
      allow delete: if isAdmin();
    }

    // --- PRODUCTS ---
    match /products/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    match /products_john/{docId} {
      allow read: if isSignedIn() && brandIsAccessible('john');
      allow write: if isAdminForBrand('john');
    }
    match /products_kivos/{docId} {
      // Allow any signed-in user with kivos brand access to read product metadata (e.g., lowStockLimit)
      allow read: if isSignedIn() && brandIsAccessible('kivos');
      allow write: if isAdminForBrand('kivos') || isWarehouseManagerForBrand('kivos');
    }

    // --- WAREHOUSE (KIVOS) ---
    match /stock_kivos/{docId} {
      allow read: if isAdminForBrand('kivos') || isWarehouseManagerForBrand('kivos');
      allow write: if isAdminForBrand('kivos') || isWarehouseManagerForBrand('kivos');
    }

    match /stock_kivos_history/{docId} {
      allow create: if request.auth != null
        && (isAdminForBrand('kivos') || isWarehouseManagerForBrand('kivos'))
        && request.resource.data.keys().hasAll(['productCode','oldQty','newQty','delta','updatedBy','timestamp']);
    }

    // --- CUSTOMERS ---
    match /customers/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    match /customers_john/{docId} {
      allow read: if isSignedIn() && brandIsAccessible('john');
      allow write: if isAdminForBrand('john');
    }
    match /customers_kivos/{docId} {
      allow read: if isSignedIn() && brandIsAccessible('kivos');
      allow write: if isAdminForBrand('kivos');
    }

    // --- IMAGES & SALESMEN ---
    match /images/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
    match /salesmen/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // --- BRAND CONTACTS ---
    match /brand_contacts/{docId} {
      allow read: if isSignedIn() && (
        !('brand' in resource.data) || brandIsAccessible(resource.data.brand)
      );
      allow write: if isAdmin();
    }

    // --- SUPERMARKETS ---
    match /supermarket_stores/{docId} {
      allow read: if isSignedIn() && myBrands().size() > 0;
      allow write: if isAdmin();
    }

    match /supermarket_listings/{docId} {
      allow read: if isSignedIn() && myBrands().size() > 0;
      allow write: if isAdmin();
    }

    match /supermarket_meta/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // --- PLAYMOBIL KPI DASHBOARD ---
    match /sheetsCache/{sheetId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // --- ORDERS ---
    match /orders/{orderId} {
      allow read: if canReadOrder(resource.data);
      allow create: if canCreateOrder(request.resource.data);
      allow update: if canUpdateOrder(request.resource.data, resource.data);
      allow delete: if canDeleteOrder(resource.data);
    }
    match /orders_john/{orderId} {
      allow read: if canReadOrder(resource.data);
      allow create: if canCreateOrder(request.resource.data);
      allow update: if canUpdateOrder(request.resource.data, resource.data);
      allow delete: if canDeleteOrder(resource.data);
    }
    match /orders_kivos/{orderId} {
      allow read: if canReadOrder(resource.data) || isWarehouseManagerForBrand('kivos');
      allow create: if canCreateOrder(request.resource.data);
      allow update: if canUpdateOrder(request.resource.data, resource.data);
      allow delete: if canDeleteOrder(resource.data);
    }
    match /orders_playmobil_supermarket/{orderId} {
      allow read: if canReadOrder(resource.data);
      allow create: if canCreateOrder(request.resource.data);
      allow update: if canUpdateOrder(request.resource.data, resource.data);
      allow delete: if canDeleteOrder(resource.data);
    }
    match /orders_john_supermarket/{orderId} {
      allow read: if canReadOrder(resource.data);
      allow create: if canCreateOrder(request.resource.data);
      allow update: if canUpdateOrder(request.resource.data, resource.data);
      allow delete: if canDeleteOrder(resource.data);
    }

    // --- SUPPLIER ORDERS (KIVOS) ---
    match /supplier_orders_kivos/{docId} {
      allow read, create, update: if isAdminForBrand('kivos') || isWarehouseManagerForBrand('kivos');
      allow delete: if isAdminForBrand('kivos');
    }

    // --- DEFAULT DENY ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
